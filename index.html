<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ESI CARD GENERATOR</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <!-- Previous styles remain the same -->
    <style>
        /* Your existing styles remain the same */
        .security-warning {
            font-size: 0.8em;
            color: #ff9966;
            margin-top: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <img src="https://assets.onecompiler.app/42um22r7s/42ukzzdeg/ESI%20Logo%202.png" alt="ESI Logo">
    <h1>ESI CARD GENERATOR</h1>
    
    <div class="container">
        <div class="input-group">
            <label for="apiKeyInput">Trello API Key:</label>
            <input type="text" id="apiKeyInput" placeholder="Enter your Trello API Key">
        </div>
        <div class="input-group">
            <label for="tokenInput">Trello Token:</label>
            <input type="text" id="tokenInput" placeholder="Enter your Trello Token">
        </div>
        <div class="save-credentials">
            <input type="checkbox" id="saveCredentials" checked>
            <label for="saveCredentials">Remember my credentials</label>
        </div>
        <div class="security-warning">
            Note: Credentials will be stored locally. Only enable this on trusted devices.
        </div>
        <button class="clear-credentials" id="clearCredentials">Clear Saved Credentials</button>
    </div>

    <!-- Rest of your HTML remains the same -->

    <script>
        // Initialize Trello Power-Up iframe
        var t = window.TrelloPowerUp.iframe();

        // Validation function for credentials
        function validateCredentials(apiKey, token) {
            if (!apiKey || !token) return false;
            // Basic format validation - adjust patterns as needed
            const apiKeyValid = apiKey.length > 0;
            const tokenValid = token.length > 0;
            return apiKeyValid && tokenValid;
        }

        // Credentials management functions with error handling
        function saveCredentials(apiKey, token) {
            if (document.getElementById('saveCredentials').checked) {
                try {
                    if (!validateCredentials(apiKey, token)) {
                        throw new Error('Invalid credential format');
                    }
                    localStorage.setItem('trelloApiKey', apiKey);
                    localStorage.setItem('trelloToken', token);
                    console.log('Credentials saved');
                } catch (error) {
                    console.error('Failed to save credentials:', error);
                    updateStatus(document.getElementById('importStatus'), 
                        'Failed to save credentials: ' + error.message, 'error');
                }
            }
        }

        function loadCredentials() {
            try {
                const apiKey = localStorage.getItem('trelloApiKey');
                const token = localStorage.getItem('trelloToken');
                
                if (apiKey && token) {
                    document.getElementById('apiKeyInput').value = apiKey;
                    document.getElementById('tokenInput').value = token;
                    console.log('Credentials loaded');
                    populateListOptions();
                }
            } catch (error) {
                console.error('Failed to load credentials:', error);
                updateStatus(document.getElementById('importStatus'), 
                    'Failed to load credentials', 'error');
            }
        }

        function clearCredentials() {
            try {
                localStorage.removeItem('trelloApiKey');
                localStorage.removeItem('trelloToken');
                document.getElementById('apiKeyInput').value = '';
                document.getElementById('tokenInput').value = '';
                document.getElementById('listSelect').innerHTML = '<option value="">Select a list...</option>';
                document.getElementById('exportListSelect').innerHTML = '<option value="">Select a list...</option>';
                console.log('Credentials cleared');
                updateStatus(document.getElementById('importStatus'), 'Credentials cleared', 'success');
            } catch (error) {
                console.error('Failed to clear credentials:', error);
                updateStatus(document.getElementById('importStatus'), 
                    'Failed to clear credentials', 'error');
            }
        }

        // Consolidated updateStatus function
        function updateStatus(element, message, type, isLoading = false) {
            console.log(`Status Update (${type}):`, message);
            element.textContent = message;
            element.className = `status ${type}`;
            if (isLoading) {
                element.classList.add('loading');
            }
        }

        // Modified populateListOptions function with proper error handling
        async function populateListOptions() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const tokenInput = document.getElementById('tokenInput');
            const importSelect = document.getElementById('listSelect');
            const exportSelect = document.getElementById('exportListSelect');
            const statusDiv = document.getElementById('importStatus');
            const refreshButton = document.getElementById('refreshLists');
            
            if (!validateCredentials(apiKeyInput.value, tokenInput.value)) {
                updateStatus(statusDiv, 'Please enter valid API key and token', 'error');
                return;
            }

            saveCredentials(apiKeyInput.value, tokenInput.value);
            
            refreshButton.disabled = true;
            updateStatus(statusDiv, 'Loading lists', 'success', true);

            try {
                const board = await t.board('id');
                const boardId = board.id;

                const testResponse = await fetch(
                    `https://api.trello.com/1/boards/${boardId}?key=${apiKeyInput.value}&token=${tokenInput.value}`
                );

                if (!testResponse.ok) {
                    throw new Error(`Invalid API credentials (${testResponse.status})`);
                }

                const listsResponse = await fetch(
                    `https://api.trello.com/1/boards/${boardId}/lists?key=${apiKeyInput.value}&token=${tokenInput.value}`
                );

                if (!listsResponse.ok) {
                    throw new Error(`Failed to fetch lists (${listsResponse.status})`);
                }

                const lists = await listsResponse.json();

                [importSelect, exportSelect].forEach(select => {
                    select.innerHTML = '<option value="">Select a list...</option>';
                    lists.forEach(list => {
                        select.add(new Option(list.name, list.id));
                    });
                });

                updateStatus(statusDiv, `Successfully loaded ${lists.length} lists`, 'success');
            } catch (error) {
                console.error('Error:', error);
                updateStatus(statusDiv, `Error: ${error.message}`, 'error');
                
                [importSelect, exportSelect].forEach(select => {
                    select.innerHTML = '<option value="">Error loading lists</option>';
                });
            } finally {
                refreshButton.disabled = false;
            }
        }

        // Your existing parseCSV, importCards, and exportCards functions remain the same

        // Debounced save function for input events
        const debouncedSave = _.debounce((apiKey, token) => {
            if (document.getElementById('saveCredentials').checked) {
                saveCredentials(apiKey, token);
            }
        }, 500);

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadCredentials();

            document.getElementById('apiKeyInput').addEventListener('input', function() {
                debouncedSave(this.value, document.getElementById('tokenInput').value);
            });

            document.getElementById('tokenInput').addEventListener('input', function() {
                debouncedSave(document.getElementById('apiKeyInput').value, this.value);
            });

            document.getElementById('apiKeyInput').addEventListener('change', populateListOptions);
            document.getElementById('tokenInput').addEventListener('change', populateListOptions);
            document.getElementById('refreshLists').addEventListener('click', populateListOptions);
            document.getElementById('importButton').addEventListener('click', importCards);
            document.getElementById('exportButton').addEventListener('click', exportCards);
            document.getElementById('clearCredentials').addEventListener('click', clearCredentials);
        });

        // Initialize Trello Power-Up
        window.TrelloPowerUp.initialize({
            'board-buttons': function(t) {
                try {
                    return [{
                        text: 'ESI CARD GENERATOR',
                        callback: async function(t) {
                            return await t.popup({
                                title: 'ESI CARD GENERATOR',
                                url: 'https://esisparky.github.io/ESI-TRELLO/index.html',
                                height: 600
                            });
                        }
                    }];
                } catch (error) {
                    console.error('Board button error:', error);
                    return [];
                }
            }
        }, {
            appKey: 'your-api-key-here', // Replace with your actual Trello API key
            appName: 'ESI CARD GENERATOR'
        });
    </script>
</body>
</html>
